{% extends 'adminside/base.html' %}

{% block extra_head %}
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cropper.js for image cropping -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
    <style>
        /* Adjust content to prevent overlap with fixed sidebar */
        .edit-product-content {
            margin-left: 280px; /* Matches sidebar width */
            padding: 24px;
            transition: margin-left 0.3s ease;
            background-color: #f9fafb; /* Light gray background */
        }

        @media (max-width: 768px) {
            .edit-product-content {
                margin-left: 0; /* No sidebar overlap on mobile */
                padding: 16px;
            }
        }

        /* Image upload area */
        .image-upload-area {
            border: 2px dashed #e5e7eb; /* gray-200 */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1rem;
            background: #f9fafb; /* gray-50 */
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .image-upload-area:hover {
            border-color: #4B0082; /* indigo-900 */
            background: #f1f5f9; /* gray-100 */
        }
        .image-upload-area.dragover {
            border-color: #4B0082; /* indigo-900 */
            background: #e5e7eb; /* gray-200 */
        }

        /* Image preview grid */
        .image-preview-grid {
            display: flex;
            flex-direction: row;
            overflow-x: auto;
            gap: 1rem;
            margin-top: 1rem;
            padding-bottom: 0.5rem;
        }
        .image-preview-item {
            background: #ffffff;
            border-radius: 0.5rem;
            padding: 0.75rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb; /* gray-200 */
            position: relative;
            flex: 0 0 auto;
            width: 150px;
        }
        .preview-image {
            width: 100%;
            max-width: 120px;
            height: auto;
            border-radius: 0.375rem;
            display: block;
            margin: auto;
        }

        /* Cropper modal */
        .cropper-container {
            background: #ffffff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            max-width: 90%;
            max-height: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }
        #cropperImage {
            max-width: 100%;
            max-height: 80vh;
            display: block;
        }

        /* Buttons */
        .delete-image-btn, .replace-image-btn {
            width: 100%;
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .delete-image-btn {
            background: #dc3545;
            color: white;
            border: none;
        }
        .delete-image-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        .replace-image-btn {
            background: #007bff;
            color: white;
            border: none;
        }
        .replace-image-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
    </style>
{% endblock %}

{% block content %}
    <div class="edit-product-content">
        <div class="container mx-auto">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-8 flex items-center gap-3">
                <i class="bi bi-pencil-square"></i> Edit Product: {{ product.name }}
            </h1>

            <!-- Messages -->
            {% if messages %}
                <div class="mb-6">
                    {% for message in messages %}
                        <div class="bg-white border border-gray-200 rounded-xl shadow-lg p-4 mb-2 text-sm text-gray-800 {% if message.tags == 'error' %}bg-red-50 text-red-700 border-red-200{% else %}bg-green-50 text-green-700 border-green-200{% endif %}">
                            {{ message }}
                            <button type="button" class="float-right text-current hover:text-gray-900" data-bs-dismiss="alert" aria-label="Close">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Product Form -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <form id="product-form" method="POST" enctype="multipart/form-data" class="product-form">
                    {% csrf_token %}
                    {{ product_form.media }}
                    {{ variant_formset.management_form }}

                    <!-- Product Details Section -->
                    <div class="mb-8 pb-6 border-b border-gray-200">
                        <h4 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
                            <i class="bi bi-info-circle"></i> Product Details
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="form-group">
                                <label class="block text-sm font-semibold text-gray-800 mb-2">{{ product_form.name.label }}</label>
                                {{ product_form.name }}
                                <div class="text-red-600 text-sm mt-2" id="error-name" style="display: none;">
                                    <i class="bi bi-exclamation-circle"></i> Product name is required
                                </div>
                                {% if product_form.name.errors %}
                                    <div class="text-red-600 text-sm mt-2">{{ product_form.name.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label class="block text-sm font-semibold text-gray-800 mb-2">{{ product_form.category.label }}</label>
                                {{ product_form.category }}
                                <div class="text-red-600 text-sm mt-2" id="error-category" style="display: none;">
                                    <i class="bi bi-exclamation-circle"></i> Category is required
                                </div>
                                {% if product_form.category.errors %}
                                    <div class="text-red-600 text-sm mt-2">{{ product_form.category.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-group md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-800 mb-2">{{ product_form.description.label }}</label>
                                {{ product_form.description }}
                                <div class="text-red-600 text-sm mt-2" id="error-description" style="display: none;">
                                    <i class="bi bi-exclamation-circle"></i> Description is required
                                </div>
                                {% if product_form.description.errors %}
                                    <div class="text-red-600 text-sm mt-2">{{ product_form.description.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label class="block text-sm font-semibold text-gray-800 mb-2">{{ product_form.price.label }}</label>
                                {{ product_form.price }}
                                <div class="text-red-600 text-sm mt-2" id="error-price" style="display: none;">
                                    <i class="bi bi-exclamation-circle"></i> Price is required
                                </div>
                                {% if product_form.price.errors %}
                                    <div class="text-red-600 text-sm mt-2">{{ product_form.price.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label class="block text-sm font-semibold text-gray-800 mb-2">{{ product_form.materials.label }}</label>
                                {{ product_form.materials }}
                                {% if product_form.materials.errors %}
                                    <div class="text-red-600 text-sm mt-2">{{ product_form.materials.errors }}</div>
                                {% endif %}
                                <small class="text-gray-600 text-sm">Optional: Enter materials used (e.g., Cotton, Polyester)</small>
                            </div>
                            <div class="form-group flex items-center gap-2">
                                {{ product_form.is_active }}
                                <label class="text-sm font-semibold text-gray-800">{{ product_form.is_active.label }}</label>
                                {% if product_form.is_active.errors %}
                                    <div class="text-red-600 text-sm mt-2">{{ product_form.is_active.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-group flex items-center gap-2">
                                {{ product_form.is_listed }}
                                <label class="text-sm font-semibold text-gray-800">{{ product_form.is_listed.label }}</label>
                                {% if product_form.is_listed.errors %}
                                    <div class="text-red-600 text-sm mt-2">{{ product_form.is_listed.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-group flex items-center gap-2">
                                {{ product_form.is_deleted }}
                                <label class="text-sm font-semibold text-gray-800">{{ product_form.is_deleted.label }}</label>
                                {% if product_form.is_deleted.errors %}
                                    <div class="text-red-600 text-sm mt-2">{{ product_form.is_deleted.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Product Variants Section -->
                    <div class="mb-8" id="variant-container">
                        <h4 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
                            <i class="bi bi-layers"></i> Product Variants
                        </h4>
                        {% if variant_formset.non_form_errors %}
                            <div class="bg-red-50 text-red-700 border border-red-200 rounded-xl p-4 mb-4">
                                {{ variant_formset.non_form_errors }}
                            </div>
                        {% endif %}
                        {% for form in variant_formset %}
                            <div class="variant-row grid grid-cols-1 md:grid-cols-6 gap-6 mb-4 p-4 bg-gray-50 rounded-xl border border-gray-200" data-variant-index="{{ forloop.counter0 }}">
                                {{ form.id }}
                                {{ form.DELETE.as_hidden }}
                                <div class="form-group">
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">{{ form.color_name.label }}</label>
                                    {{ form.color_name }}
                                    <div class="text-red-600 text-sm mt-2" id="error-variant-{{ forloop.counter0 }}-color_name" style="display: none;">
                                        <i class="bi bi-exclamation-circle"></i> Color name is required
                                    </div>
                                    {% if form.color_name.errors %}
                                        <div class="text-red-600 text-sm mt-2">{{ form.color_name.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="form-group">
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">{{ form.color_hex.label }}</label>
                                    {{ form.color_hex }}
                                    {% if form.color_hex.errors %}
                                        <div class="text-red-600 text-sm mt-2">{{ form.color_hex.errors }}</div>
                                    {% endif %}
                                    <small class="text-gray-600 text-sm">Optional hex color</small>
                                </div>
                                <div class="form-group">
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">{{ form.size.label }}</label>
                                    {{ form.size }}
                                    <div class="text-red-600 text-sm mt-2" id="error-variant-{{ forloop.counter0 }}-size" style="display: none;">
                                        <i class="bi bi-exclamation-circle"></i> Size is required
                                    </div>
                                    {% if form.size.errors %}
                                        <div class="text-red-600 text-sm mt-2">{{ form.size.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="form-group">
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">{{ form.stock.label }}</label>
                                    {{ form.stock }}
                                    <div class="text-red-600 text-sm mt-2" id="error-variant-{{ forloop.counter0 }}-stock" style="display: none;">
                                        <i class="bi bi-exclamation-circle"></i> Stock is required
                                    </div>
                                    {% if form.stock.errors %}
                                        <div class="text-red-600 text-sm mt-2">{{ form.stock.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="form-group md:col-span-2">
                                    <div class="image-upload-area variant-upload-area" data-variant-index="{{ forloop.counter0 }}">
                                        <i class="bi bi-upload text-4xl text-gray-600 mb-3"></i>
                                        <p class="text-gray-800 font-medium">Drag and drop variant images or click to upload</p>
                                        <p class="text-gray-600 text-sm">Upload any number of images (JPEG/PNG/WebP)</p>
                                        <input type="file" class="variant-image-input" name="variant-{{ forloop.counter0 }}-images" accept="image/jpeg,image/png,image/webp" multiple hidden>
                                    </div>
                                    <div class="image-preview-grid variant-image-preview" data-variant-index="{{ forloop.counter0 }}">
                                        {% if form.instance.color_variant %}
                                            {% for img in form.instance.color_variant.images.all %}
                                                <div class="image-preview-item" data-image-index="{{ forloop.counter0 }}" data-image-id="{{ img.id }}">
                                                    <img src="{{ img.image.url }}" class="preview-image" alt="Variant Image {{ forloop.counter0 }}">
                                                    <button type="button" class="delete-image-btn" data-image-id="{{ img.id }}" data-variant-index="{{ forloop.parentloop.counter0 }}">
                                                        <i class="bi bi-trash"></i> Delete
                                                    </button>
                                                    <button type="button" class="replace-image-btn" data-image-id="{{ img.id }}" data-variant-index="{{ forloop.parentloop.counter0 }}" data-image-index="{{ forloop.counter0 }}">
                                                        <i class="bi bi-arrow-repeat"></i> Replace
                                                    </button>
                                                </div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                    <div class="text-red-600 text-sm mt-2" id="error-variant-{{ forloop.counter0 }}-images" style="display: none;">
                                        <i class="bi bi-exclamation-circle"></i> At least one image is required
                                    </div>
                                    <div class="text-red-600 text-sm mt-2 variant-image-error" data-variant-index="{{ forloop.counter0 }}" style="display: none;"></div>
                                    <div class="text-teal-600 text-sm mt-2 variant-image-status" data-variant-index="{{ forloop.counter0 }}" style="display: none;"></div>
                                </div>
                                <div class="form-group flex items-end">
                                    <button type="button" class="delete-variant bg-red-600 text-white p-2 rounded-lg hover:bg-red-700 transition-colors text-sm">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                        <button type="button" id="add-variant-btn" class="bg-indigo-900 text-white p-2 rounded-lg hover:bg-teal-500 transition-colors text-sm mt-2">
                            <i class="bi bi-plus"></i> Add Variant
                        </button>
                    </div>

                    <!-- Submit Section -->
                    <div class="pt-6 border-t border-gray-200 text-center">
                        <a href="{% url 'adminside:product_list' %}" class="bg-gray-100 text-gray-800 p-2 rounded-lg hover:bg-gray-200 transition-colors text-sm mr-2">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                        <button type="submit" class="bg-indigo-900 text-white p-2 rounded-lg hover:bg-teal-500 transition-colors text-sm" id="submit-btn">
                            <i class="bi bi-check-circle"></i> Update Product
                        </button>
                    </div>
                </form>
            </div>

            <!-- Cropper Modal -->
            <div id="cropperModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-[9999]">
                <div class="cropper-container">
                    <h5 id="crop-title" class="text-lg font-semibold text-gray-900 mb-4">Crop Image</h5>
                    <img id="cropperImage" src="" class="max-w-full max-h-[80vh]">
                    <div class="mt-4 text-right">
                        <button type="button" id="cancelCropBtn" class="bg-gray-100 text-gray-800 p-2 rounded-lg hover:bg-gray-200 transition-colors text-sm mr-2">Cancel</button>
                        <button type="button" id="cropImageBtn" class="bg-indigo-900 text-white p-2 rounded-lg hover:bg-teal-500 transition-colors text-sm">Crop and Continue</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <script>
        const form = document.getElementById('product-form');
        const cropperModal = document.getElementById('cropperModal');
        const cropperImage = document.getElementById('cropperImage');
        const cropBtn = document.getElementById('cropImageBtn');
        const cancelCropBtn = document.getElementById('cancelCropBtn');
        const cropTitle = document.getElementById('crop-title');
        const submitBtn = document.getElementById('submit-btn');
        const variantContainer = document.getElementById('variant-container');
        const addVariantBtn = document.getElementById('add-variant-btn');
        const variantTotalForms = document.querySelector('#id_variants-TOTAL_FORMS');
        const variantInitialForms = document.querySelector('#id_variants-INITIAL_FORMS');
        const ALLOWED_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/webp'];

        let cropper;
        let currentFileIndex = 0;
        let filesToCrop = [];
        let isProcessingImages = false;
        let currentContext = null;
        let variantCroppedImages = {};

        // Initialize formset management
        if (variantTotalForms) {
            console.log('Initial TOTAL_FORMS:', variantTotalForms.value);
        }

        // Initialize variant image storage
        function initializeVariantImages() {
            document.querySelectorAll('.variant-row').forEach(row => {
                const index = row.dataset.variantIndex;
                variantCroppedImages[index] = [];
            });
        }
        initializeVariantImages();

        // Remove required attributes from all form fields
        function removeRequiredAttributes() {
            document.querySelectorAll('input, select, textarea').forEach(field => {
                field.removeAttribute('required');
            });
        }
        removeRequiredAttributes();

        // Event Listeners
        variantContainer.addEventListener('dragover', handleDragOver);
        variantContainer.addEventListener('dragleave', handleDragLeave);
        variantContainer.addEventListener('drop', handleDrop);
        variantContainer.addEventListener('click', handleClick);
        variantContainer.addEventListener('change', handleFileInputChange);

        function handleDragOver(e) {
            const uploadArea = e.target.closest('.variant-upload-area');
            if (uploadArea && !isProcessingImages) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            }
        }

        function handleDragLeave(e) {
            const uploadArea = e.target.closest('.variant-upload-area');
            if (uploadArea) {
                uploadArea.classList.remove('dragover');
            }
        }

        function handleDrop(e) {
            const uploadArea = e.target.closest('.variant-upload-area');
            if (uploadArea && !isProcessingImages) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const variantIndex = uploadArea.dataset.variantIndex;
                handleFiles(e.dataTransfer.files, { type: 'variant', index: variantIndex, replaceImageIndex: null, replaceImageId: null });
            }
        }

        function handleClick(e) {
            const uploadArea = e.target.closest('.variant-upload-area');
            const deleteBtn = e.target.closest('.delete-image-btn');
            const replaceBtn = e.target.closest('.replace-image-btn');
            const deleteVariantBtn = e.target.closest('.delete-variant');

            if (uploadArea && !isProcessingImages) {
                const variantIndex = uploadArea.dataset.variantIndex;
                const input = uploadArea.querySelector('.variant-image-input');
                input.click();
            }

            if (deleteBtn) {
                e.preventDefault();
                const imageId = deleteBtn.dataset.imageId;
                const variantIndex = deleteBtn.dataset.variantIndex;
                deleteImage(imageId, variantIndex);
            }

            if (replaceBtn) {
                e.preventDefault();
                const variantIndex = replaceBtn.dataset.variantIndex;
                const imageIndex = parseInt(replaceBtn.dataset.imageIndex);
                const imageId = replaceBtn.dataset.imageId;
                console.log(`Initiating replace for variant ${variantIndex}, image index ${imageIndex}, image ID ${imageId}`);

                const input = document.createElement('input');
                input.type = 'file';
                input.accept = ALLOWED_IMAGE_TYPES.join(',');
                input.style.display = 'none';
                input.addEventListener('change', () => {
                    if (input.files.length === 1) {
                        console.log(`Selected file for replacement: ${input.files[0].name}`);
                        if (imageId && imageId !== 'undefined') {
                            const deleteInput = document.createElement('input');
                            deleteInput.type = 'hidden';
                            deleteInput.name = `variant-${variantIndex}-delete_image_${imageId}`;
                            deleteInput.value = '1';
                            form.appendChild(deleteInput);
                            console.log(`Added delete input for image ID ${imageId}`);
                        }
                        handleFiles(input.files, {
                            type: 'variant',
                            index: variantIndex,
                            replaceImageIndex: imageIndex,
                            replaceImageId: imageId
                        });
                    }
                    input.remove();
                });
                document.body.appendChild(input);
                input.click();
            }

            if (deleteVariantBtn) {
                e.preventDefault();
                const row = deleteVariantBtn.closest('.variant-row');
                const index = row.dataset.variantIndex;
                const deleteInput = row.querySelector('input[name$="-DELETE"]');
                if (deleteInput) {
                    deleteInput.value = 'on';
                    row.style.display = 'none';
                    console.log(`Marked variant ${index} for deletion`);
                } else {
                    row.remove();
                    console.log(`Removed variant ${index} from DOM`);
                }
                delete variantCroppedImages[index];
                removeHiddenImageInputs({ type: 'variant', index });
            }
        }

        function handleFileInputChange(e) {
            if (e.target.classList.contains('variant-image-input') && !isProcessingImages) {
                const variantIndex = e.target.closest('.variant-upload-area').dataset.variantIndex;
                handleFiles(e.target.files, { type: 'variant', index: variantIndex, replaceImageIndex: null, replaceImageId: null });
            }
        }

        function handleFiles(files, context) {
            const imageFiles = Array.from(files).filter(f => ALLOWED_IMAGE_TYPES.includes(f.type));
            if (imageFiles.length === 0) {
                showImageError('Please select at least one valid image (JPEG, PNG, or WebP).', context);
                return;
            }
            if (context.replaceImageIndex !== null) {
                if (imageFiles.length !== 1) {
                    showImageError('Please select exactly one image to replace.', context);
                    return;
                }
            }
            filesToCrop = imageFiles;
            currentContext = context;
            console.log(`Starting crop for ${imageFiles.length} images for variant ${context.index}`);
            startCropping();
        }

        function startCropping() {
            isProcessingImages = true;
            currentFileIndex = 0;
            hideImageError(currentContext);
            updateUploadAreaState(currentContext);
            const input = document.querySelector(`.variant-image-input[name="variant-${currentContext.index}-images"]`);
            if (input) input.value = '';
            openCropper(filesToCrop[currentFileIndex]);
        }

        function openCropper(file) {
            cropTitle.textContent = currentContext.replaceImageIndex !== null
                ? `Crop Replacement Image for Variant ${parseInt(currentContext.index) + 1}, Image ${currentContext.replaceImageIndex + 1}`
                : `Crop Image ${currentFileIndex + 1} for Variant ${parseInt(currentContext.index) + 1}`;
            const reader = new FileReader();
            reader.onload = () => {
                cropperImage.src = reader.result;
                cropperModal.classList.remove('hidden');
                if (cropper) {
                    cropper.destroy();
                }
                cropper = new Cropper(cropperImage, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 0.8,
                    responsive: true,
                    scalable: true,
                    zoomable: true,
                });
            };
            reader.readAsDataURL(file);
        }

        cropBtn.addEventListener('click', () => {
            if (!cropper) return;
            const canvas = cropper.getCroppedCanvas({
                width: 500,
                height: 500,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });
            canvas.toBlob(blob => {
                const fileName = `cropped_image_${currentContext.replaceImageIndex !== null ? currentContext.replaceImageIndex + 1 : currentFileIndex + 1}_${Date.now()}.jpg`;
                const file = new File([blob], fileName, {
                    type: 'image/jpeg',
                    lastModified: Date.now()
                });
                variantCroppedImages[currentContext.index] = variantCroppedImages[currentContext.index] || [];
                if (currentContext.replaceImageIndex !== null) {
                    variantCroppedImages[currentContext.index][currentContext.replaceImageIndex] = file;
                    const previewContainer = getPreviewContainer(currentContext);
                    const previewItem = previewContainer.querySelector(`.image-preview-item[data-image-index="${currentContext.replaceImageIndex}"]`);
                    if (previewItem) {
                        previewItem.querySelector('img').src = canvas.toDataURL();
                        previewItem.dataset.isReplaced = 'true';
                        previewItem.dataset.replacementIndex = currentContext.replaceImageIndex;
                        console.log(`Updated preview for variant ${currentContext.index}, image index ${currentContext.replaceImageIndex}`);
                    }
                    cropperModal.classList.add('hidden');
                    if (cropper) {
                        cropper.destroy();
                        cropper = null;
                    }
                    finishImageProcessing();
                } else {
                    variantCroppedImages[currentContext.index].push(file);
                    previewImage(canvas.toDataURL(), variantCroppedImages[currentContext.index].length, currentContext);
                    cropperModal.classList.add('hidden');
                    if (cropper) {
                        cropper.destroy();
                        cropper = null;
                    }
                    currentFileIndex++;
                    if (currentFileIndex < filesToCrop.length) {
                        openCropper(filesToCrop[currentFileIndex]);
                    } else {
                        finishImageProcessing();
                    }
                }
            }, 'image/jpeg', 0.85);
        });

        cancelCropBtn.addEventListener('click', () => {
            cropperModal.classList.add('hidden');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            isProcessingImages = false;
            updateUploadAreaState(currentContext);
        });

        function finishImageProcessing() {
            isProcessingImages = false;
            updateHiddenImageInputs(currentContext);
            updateUploadAreaState(currentContext);
            showImageStatus(currentContext);
            console.log('Image processing completed for', currentContext);
        }

        function previewImage(dataURL, index, context) {
            const wrapper = document.createElement('div');
            wrapper.className = 'image-preview-item';
            wrapper.dataset.imageIndex = index - 1;
            wrapper.dataset.isNew = 'true';
            const img = document.createElement('img');
            img.src = dataURL;
            img.className = 'preview-image';
            img.alt = `Variant Image ${index}`;
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'delete-image-btn';
            deleteBtn.dataset.variantIndex = context.index;
            deleteBtn.dataset.imageIndex = index - 1;
            deleteBtn.innerHTML = '<i class="bi bi-trash"></i> Delete';
            const replaceBtn = document.createElement('button');
            replaceBtn.type = 'button';
            replaceBtn.className = 'replace-image-btn';
            replaceBtn.dataset.variantIndex = context.index;
            replaceBtn.dataset.imageIndex = index - 1;
            replaceBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Replace';
            wrapper.appendChild(img);
            wrapper.appendChild(deleteBtn);
            wrapper.appendChild(replaceBtn);
            getPreviewContainer(context).appendChild(wrapper);
            console.log(`Previewed new image ${index} for variant ${context.index}`);
        }

        function deleteImage(imageId, variantIndex) {
            console.log(`Deleting image ID ${imageId} from variant ${variantIndex}`);
            const previewContainer = document.querySelector(`.variant-image-preview[data-variant-index="${variantIndex}"]`);
            const previewItem = previewContainer.querySelector(`.image-preview-item[data-image-id="${imageId}"]`);
            if (previewItem) {
                if (previewItem.dataset.isReplaced === 'true') {
                    variantCroppedImages[variantIndex][previewItem.dataset.replacementIndex] = null;
                    console.log(`Removed replacement image at index ${previewItem.dataset.replacementIndex} for variant ${variantIndex}`);
                } else if (imageId) {
                    const deleteInput = document.createElement('input');
                    deleteInput.type = 'hidden';
                    deleteInput.name = `variant-${variantIndex}-delete_image_${imageId}`;
                    deleteInput.value = '1';
                    form.appendChild(deleteInput);
                    console.log(`Marked image ID ${imageId} for deletion in variant ${variantIndex}`);
                }
                previewItem.remove();
                console.log(`Removed preview item for image ID ${imageId}`);
            }
            updateUploadAreaState({ type: 'variant', index: variantIndex });
            showImageStatus({ type: 'variant', index: variantIndex });
        }

        function getPreviewContainer(context) {
            return document.querySelector(`.variant-image-preview[data-variant-index="${context.index}"]`);
        }

        function updateHiddenImageInputs(context) {
            removeHiddenImageInputs(context);
            const images = (variantCroppedImages[context.index] || []).filter(file => file && ALLOWED_IMAGE_TYPES.includes(file.type));
            images.forEach((file, index) => {
                if (!file) {
                    console.warn(`Skipping invalid file at index ${index} for variant ${context.index}`);
                    return;
                }
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                const input = document.createElement('input');
                input.type = 'file';
                input.name = `variant-${context.index}-images`;
                input.files = dataTransfer.files;
                input.style.display = 'none';
                input.setAttribute('data-cropped-image', `variant-${context.index}-${index}`);
                form.appendChild(input);
                console.log(`Hidden input created for ${input.name}:`, file.name, file.size, 'bytes', file.type);
            });
        }

        function removeHiddenImageInputs(context) {
            document.querySelectorAll(`input[data-cropped-image^="variant-${context.index}-"]`).forEach(el => el.remove());
        }

        function updateUploadAreaState(context) {
            const uploadArea = document.querySelector(`.variant-upload-area[data-variant-index="${context.index}"]`);
            const images = (variantCroppedImages[context.index] || []).filter(file => file && ALLOWED_IMAGE_TYPES.includes(file.type));
            const previewContainer = getPreviewContainer(context);
            const totalImages = images.length + previewContainer.querySelectorAll('.image-preview-item:not([data-is-replaced="true"])').length;
            uploadArea.style.opacity = '1';
            uploadArea.style.pointerEvents = 'auto';
            uploadArea.querySelector('.text-gray-800').textContent = totalImages > 0
                ? `${totalImages} image${totalImages === 1 ? '' : 's'} uploaded. Add more or click to replace.`
                : 'Drag and drop images or click to upload';
        }

        function showImageError(message, context) {
            const errorElement = document.querySelector(`.variant-image-error[data-variant-index="${context.index}"]`);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        function hideImageError(context) {
            const errorElement = document.querySelector(`.variant-image-error[data-variant-index="${context.index}"]`);
            if (errorElement) {
                errorElement.style.display = 'none';
            }
        }

        function showImageStatus(context) {
            const statusElement = document.querySelector(`.variant-image-status[data-variant-index="${context.index}"]`);
            const previewContainer = getPreviewContainer(context);
            const totalImages = previewContainer.querySelectorAll('.image-preview-item').length;
            if (statusElement && totalImages > 0) {
                statusElement.textContent = `${totalImages} image${totalImages === 1 ? '' : 's'} ready for upload`;
                statusElement.style.display = 'block';
            } else if (statusElement) {
                statusElement.style.display = 'none';
            }
        }

        // Add variant functionality
        if (addVariantBtn) {
            addVariantBtn.addEventListener('click', () => {
                const currentTotal = parseInt(variantTotalForms.value);
                const newIndex = currentTotal;
                const newVariantRow = createNewVariantRow(newIndex);
                variantContainer.insertBefore(newVariantRow, addVariantBtn);
                variantTotalForms.value = currentTotal + 1;
                variantCroppedImages[newIndex] = [];
                console.log(`Added new variant with index ${newIndex}. Total forms: ${variantTotalForms.value}`);
                // Remove required attributes from new variant fields
                newVariantRow.querySelectorAll('input, select, textarea').forEach(field => {
                    field.removeAttribute('required');
                });
            });
        }

        function createNewVariantRow(index) {
            const template = document.querySelector('.variant-row');
            const newRow = template.cloneNode(true);
            newRow.dataset.variantIndex = index;
            newRow.querySelectorAll('[name], [id]').forEach(element => {
                if (element.name) {
                    element.name = element.name.replace(/variants-\d+-/, `variants-${index}-`);
                }
                if (element.id) {
                    element.id = element.id.replace(/id_variants-\d+-/, `id_variants-${index}-`);
                }
                if (element.type !== 'hidden') {
                    if (element.tagName === 'SELECT') {
                        element.selectedIndex = 0;
                    } else if (element.type !== 'checkbox') {
                        element.value = '';
                    }
                }
                // Remove required attribute
                element.removeAttribute('required');
            });
            newRow.querySelectorAll('label[for]').forEach(label => {
                label.setAttribute('for', label.getAttribute('for').replace(/id_variants-\d+-/, `id_variants-${index}-`));
            });
            newRow.querySelectorAll('.text-red-600').forEach(error => {
                if (error.id && error.id.startsWith('error-variant-')) {
                    error.id = error.id.replace(/error-variant-\d+-/, `error-variant-${index}-`);
                    error.style.display = 'none';
                } else if (!error.classList.contains('variant-image-error')) {
                    error.remove();
                }
            });
            const previewContainer = newRow.querySelector('.variant-image-preview');
            previewContainer.innerHTML = '';
            previewContainer.dataset.variantIndex = index;
            newRow.querySelector('.variant-upload-area').dataset.variantIndex = index;
            newRow.querySelector('.variant-image-input').name = `variant-${index}-images`;
            newRow.querySelector('.variant-image-error').dataset.variantIndex = index;
            newRow.querySelector('.variant-image-status').dataset.variantIndex = index;
            newRow.querySelector('.variant-image-status').style.display = 'none';
            newRow.querySelector('.text-gray-800').textContent = 'Drag and drop images or click to upload';
            return newRow;
        }

        // Form submission validation
        form.addEventListener('submit', function(e) {
            console.log('Form submission attempted');
            let hasErrors = false;
            let activeVariants = 0;

            // Clear previous custom error messages
            document.querySelectorAll('.text-red-600[id^="error-"]').forEach(error => {
                error.style.display = 'none';
            });
            document.querySelectorAll('.bg-red-50').forEach(alert => {
                if (alert.textContent.includes('At least one variant is required')) {
                    alert.remove();
                }
            });

            // Validate product fields
            const productFields = [
                { id: 'id_name', errorId: 'error-name' },
                { id: 'id_category', errorId: 'error-category' },
                { id: 'id_description', errorId: 'error-description' },
                { id: 'id_price', errorId: 'error-price' }
            ];

            productFields.forEach(field => {
                const input = document.getElementById(field.id);
                if (input && !input.value.trim()) {
                    document.getElementById(field.errorId).style.display = 'block';
                    hasErrors = true;
                }
            });

            // Validate variant fields
            document.querySelectorAll('.variant-row').forEach(row => {
                const index = row.dataset.variantIndex;
                const deleteInput = row.querySelector(`input[name="variants-${index}-DELETE"]`);
                if ((deleteInput && deleteInput.value === 'on') || row.style.display === 'none') {
                    return;
                }
                const colorNameInput = row.querySelector(`input[name="variants-${index}-color_name"]`);
                const hasContent = colorNameInput.value.trim();
                if (!hasContent) {
                    return;
                }
                activeVariants++;

                const variantFields = [
                    { id: `id_variants-${index}-color_name`, errorId: `error-variant-${index}-color_name` },
                    { id: `id_variants-${index}-size`, errorId: `error-variant-${index}-size` },
                    { id: `id_variants-${index}-stock`, errorId: `error-variant-${index}-stock` }
                ];

                variantFields.forEach(field => {
                    const input = document.getElementById(field.id);
                    if (input && !input.value.trim()) {
                        document.getElementById(field.errorId).style.display = 'block';
                        hasErrors = true;
                    }
                });

                // Validate images
                const previewContainer = document.querySelector(`.variant-image-preview[data-variant-index="${index}"]`);
                const totalImages = (variantCroppedImages[index] || []).filter(file => file && ALLOWED_IMAGE_TYPES.includes(file.type)).length +
                                    previewContainer.querySelectorAll('.image-preview-item:not([data-is-replaced="true"])').length;
                if (totalImages === 0) {
                    document.getElementById(`error-variant-${index}-images`).style.display = 'block';
                    hasErrors = true;
                }
            });

            if (activeVariants === 0) {
                const errorAlert = document.createElement('div');
                errorAlert.className = 'bg-red-50 text-red-700 border border-red-200 rounded-xl p-4 mb-4';
                errorAlert.textContent = 'At least one variant is required.';
                variantContainer.insertBefore(errorAlert, variantContainer.firstChild);
                hasErrors = true;
            }

            if (hasErrors) {
                e.preventDefault();
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Update Product';
                return false;
            }

            Object.keys(variantCroppedImages).forEach(index => {
                const row = document.querySelector(`.variant-row[data-variant-index="${index}"]`);
                if (row && row.style.display !== 'none') {
                    updateHiddenImageInputs({ type: 'variant', index });
                }
            });
            document.querySelectorAll('.variant-image-input').forEach(input => {
                input.value = '';
            });
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Updating Product...';
            return true;
        });
    </script>
{% endblock %}